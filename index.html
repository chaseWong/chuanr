<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Chuanr Testing</title>
    <link href='http://fonts.googleapis.com/css?family=Noto+Sans' rel='stylesheet' type='text/css'>
    <style type="text/css">
    html
    {
        color: #FFF;
        font-family: Noto Sans, Arial;
        background:#3C454F;
    }
    h1
    {
        margin: 2em auto;

        font-family: Noto Sans, Arial;
        color: #FFF;
        text-align: center;
    }
    section
    {
        margin: 1em auto;
        width: 80%;

        text-align: center;
        transition: all .5s;
        zoom: 1;
    }
    section:before
    {
        display: table;
        content: ' '
    }
    section:after
    {
        display: table;
        content: ' '
    }
    section > .inner
    {
        margin: 1em;
    }
    section > .inner > .column
    {
        width: 152px;
        float: left;
        font-size: 12px;
    }
    section:empty
    {
        display: none;
    }
    span
    {
        line-height: 1.8em;
    }
    span.highlight
    {
        display: inline-block;
        
        border-radius: .7em;
        padding: 0 .6em;

        background-color: #8BC53F;
        cursor: pointer;
    }
    .message span.highlight
    {
        padding: 0 .1em;
    }
    button
    {
        cursor: pointer;
    }
    input, 
    button
    {
        outline: none;
        border: 1px solid #428BCA;
        padding: 1em;

        color: #FFF;
        font-weight: bolder;
        font-family: Courier , Courier New;
        background: #428BCA;
        transition: all .6s;
    }
    input + button.validate
    {
        background-color: #8BC53F;
        border-color: #8BC53F;
    }
    input.success,
    button.success
    {
        border: 1px solid #8BC53F;

        background-color: #8BC53F;
    }
    input.error,
    button.error
    {
        border: 1px solid #D9534F;

        background-color: #D9534F;
    }
    input.small,
    input[type=checkbox] 
    {
        padding: 5px;
        height: 5px;
    }
    input[type=checkbox] 
    {
        -webkit-appearance: none;
        width: 5px;

        cursor: pointer;
    }
    input[type=checkbox]:checked
    {
        background-color: #125B9A;
    }
    input + .tip
    {
        position: absolute;

        margin: 2px;
        padding: 5px;
        width: 154px;

        opacity: 0;
        font-size: 9px;
        text-align: left;
        
        background-color: #8BC53F;
    }
    .field
    {
        position: relative;
        display: inline-block;
    }
    section > * 
    {
        vertical-align: middle;
    }
    section.patterns
    {
        opacity: 0;
        background-color: #8BC53F;
    }
    section.info
    {
        opacity: 0;
        background-color: #D9534F;
    }
    fieldset
    {
        border-width: 1px;
        text-align: left;
    }
    fieldset > legend 
    {
        background-color: #428BCA;
    }
    fieldset > * 
    {
        vertical-align: middle;;
    }
    #message-box
    {
        font-family: Courier , Courier New;
    }


    @-webkit-keyframes shake {
      0%, 100% {
        -webkit-transform: translateX(0);
        transform: translateX(0);
      }

      10%, 30%, 50%, 70%, 90% {
        -webkit-transform: translateX(-10px);
        transform: translateX(-10px);
      }

      20%, 40%, 60%, 80% {
        -webkit-transform: translateX(10px);
        transform: translateX(10px);
      }
    }

    @keyframes shake {
      0%, 100% {
        -webkit-transform: translateX(0);
        -ms-transform: translateX(0);
        transform: translateX(0);
      }

      10%, 30%, 50%, 70%, 90% {
        -webkit-transform: translateX(-10px);
        -ms-transform: translateX(-10px);
        transform: translateX(-10px);
      }

      20%, 40%, 60%, 80% {
        -webkit-transform: translateX(10px);
        -ms-transform: translateX(10px);
        transform: translateX(10px);
      }
    }

    .shake {
      -webkit-animation-name: shake;
      animation-name: shake;
    }

    .animated {
      -webkit-animation-duration: .6s;
      animation-duration: .6s;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
    }

    .animated.hinge {
      -webkit-animation-duration: 2s;
      animation-duration: 2s;
    }

    </style>
</head>
<body>
    <script type="text/javascript" src="./res/require.js"></script>
    <h1>CHUANR</h1>
    <section>
        <div class='wizard'>
            Type in below &lt;INPUT /&gt; box, Chuanr will masking and formatting against <span id="btn-patterns" class='highlight patterns'>patterns</span> . 
        </div>
    </section>
    <section class='options'>
        <form action="">
            <fieldset>
                <legend>
                    Options
                </legend>
                <label for="placeholder">Use Underline as Placeholder</label> <input name="placeholder" class="small" id="chk-placeholder" type="checkbox" />
            </fieldset>
        </form>
    </section>
    <section>
        <form id="form" action="http://httpbin.org/post" method="POST">
            <div class="field">
                <input id="firstname" name="firstname" type="text" placeholder="First Name" />
                <div class="firstname tip"></div>
            </div>
            <div class="field">
                <input id="lastname" name="lastname" type="text" placeholder="Last Name" />
                <div class="lastname tip"></div>
            </div>
            <div class="field">
                <input id="phone" name="phone" type="text" placeholder="Phone Number" /> 
                <div class="phone tip"></div>
            </div>
            <div class="field">
                <input id="creditcard" name="creditcard" type="text" placeholder="Credit card" /> 
                <div class="creditcard tip"></div>
            </div>
            <button id="btn-check">Check Integrity and Submit</button>
        </form>
    </section>
    <section class='info'>
        <div class="inner">
            <pre id="message-box" class="message">no error</pre>
        </div>
    </section>
    <script type="text/javascript">
        require(['./res/ready'], function(domready){
            domready(function () {
                var isDebug = location.hash.indexOf('debug') > 0;
                require([ (isDebug ? './src/Chuanr': './Chuanr')], function( Chuanr ){

                    function showPatterns(){
                        var tips = document.getElementsByClassName('tip');
                        var cur, text, curTip;

                        for( var l = creationInfo.length; l--; ) {
                            cur = creationInfo[l];
                            curTip = tips[l];

                            if ( curTip == null ) {
                                continue;
                            }

                            text = cur.instance.patterns.toString().replace(/,/g, ',\n');;

                            curTip.style.display = 'block';
                            if ( 'innerText' in curTip ) {
                                curTip.innerText = text;
                            }
                            else {
                                curTip.textContent = text;
                            }

                        }
                    }
                    function hidePatterns(){
                        var tips = document.getElementsByClassName('tip');
                        for(var l = tips.length; l--;){
                            tips[l].style.display = 'none';
                        }
                    }

                    function scheduleErrorClear(elInput){
                        if ( schHandle ) {
                            clearTimeout( schHandle );
                            schHandle = null;
                        }
                        schHandle = setTimeout(function(){
                            elInput.className = elInput.className.replace('error','');
                        }, 1000);
                    }

                    function getOnResume(elInput){
                        return function(){
                            elInput.className = '';
                            // elMessageBox.innerText = '';
                            elMessageBox.parentNode.parentNode.style.opacity = '0';
                        }
                    }

                    function getOnPrevent(elInput) {
                        return function onPrevent(format){
                            var curItem;
                            var genericPattern = Chuanr.setting.Pattern.parse(
                                format.pattern.pattern + '{*}'
                            );
                            for(var i = 0; i < genericPattern.items.length; i++) {
                                curItem = genericPattern.items[i];
                                if ( curItem.type == 2 ) {
                                    curItem.param = '';
                                    curItem.value = '*';
                                }
                            }

                            var genericFormatter = new Chuanr.setting.Formatter([genericPattern]);

                            var input = format.input.replace(/[\(\){}\-\ ]/g, '');

                            for(var i = 0; i < input.length; i++){
                                genericFormatter.input(input.charAt(i));    
                            }

                            var output = genericFormatter.output();
                            var msg = '"' + ( output.result + '' ).replace(/(\d)(\W*)$/,'<span class="highlight">$1</span>$2')  + '" is not an valid input for current field!';
                            window.console && window.console.error('Prevented!! ' + msg);
                            elMessageBox.innerHTML = msg;
                            elMessageBox.parentNode.parentNode.style.opacity = '1';

                            elInput.className = 'error shake animated';
                            scheduleErrorClear(elInput);
                            hidePatterns();
                        }
                    };

                    function createChuanr() {
                        var cur, inst;

                        for( var l = creationInfo.length; l--; ) {
                            cur = creationInfo[l];
                            inst = cur.instance;

                            if ( inst ) {
                                inst.dispose();
                            }

                            inst = new Chuanr({
                                placeholder: {
                                    empty: chkUnderline.checked ? '_' : ' ',
                                    always: cur.config && cur.config.placeholder && cur.config.placeholder.always
                                }
                            });

                            inst.roast( cur.el, cur.patterns );
                            inst.on('prevented', getOnPrevent(cur.el));
                            inst.on('resumed', getOnResume(cur.el));

                            !function(el, inst){
                                el.onblur = function() {
                                    if ( inst.intact() ) {
                                        el.className += ' success';
                                    }
                                };
                                el.onfocus = function() {
                                    el.className = el.className.replace(' success', '');
                                };
                            }(cur.el, inst);

                            cur.instance = inst;
                        }
                    }

                    var schHandle;
                    var elInput = document.getElementById('phone');
                    var elFirstName = document.getElementById('firstname');
                    var elLastName = document.getElementById('lastname');
                    var elCreditcard = document.getElementById('creditcard');
                    var elMessageBox = document.getElementById('message-box');
                    var elBtnPatterns = document.getElementById('btn-patterns');
                    var elBtnCheck = document.getElementById('btn-check');
                    var chkUnderline = document.getElementById('chk-placeholder');
                    var elForm = document.getElementById('form');
                    var namePatterns = [];

                    !function( pttns ){
                        for(var i = 3; i < 20; i++ ) {
                            var sPttn = '{';
                            for(var j = 0; j < i ; j++ ) {
                                sPttn+='a';
                            }
                            sPttn +='}';
                            pttns.push(sPttn);
                        }
                    }(namePatterns);
                        
                    var creationInfo = [
                        {
                            'el': elFirstName,
                            'patterns': namePatterns
                        },
                        {
                            'el': elLastName,
                            'patterns': namePatterns
                        },
                        {
                            'el': elInput,
                            'patterns': [
                                "({11}) {99ddd}-{dddd}",
                                "({11}) {98d}-{ddd}-{ddd}",
                                "({11}) {97d(01234569)dd}-{dddd}",
                                "({11}) {96ddd}-{dddd}",
                                "({11}) {95ddd}-{dddd}",
                                "({dd}) {700d}-{dddd}",
                                "({dd}) {7010}-{dddd}",
                                "({dd}) {77dd}-{dddd}",
                                "({dd}) {78dd}-{dddd}",
                                "({dd}) {790d(124)}-{dddd}",
                                "({dd}) {791d(2-9)}-{dddd}",
                                "({dd}) {792d(03489)}-{dddd}",
                                "({dd}) {793d(012456789)}-{dddd}",
                                "({dd}) {794d}-{dddd}",
                                "({11}) {d(2345)ddd}-{dddd}",
                                "-|({11}) {d(2345)d(+1)d(+1)d(+1)}-{d(+1)d(+1)}",
                                "_|{1199dd(+)d(+)d(?)d(?)d(?)d(?)}"
                            ],
                            'config': {
                                placeholder: {
                                    always: true
                                }
                            }
                        },
                        {
                            'el': elCreditcard,
                            'patterns': [
                                // AMEX
                                "{34ddd}-{ddddd}-{ddddl}",
                                "{37ddd}-{ddddd}-{ddddl}",
                                // DINERS CLUB - CARTE BLANCHE
                                "{30d(0-5)dd}-{ddddd}-{dddl}",
                                // DINERS CLUB - INTERNATIONAL
                                "{36ddd}-{ddddd}-{dddl}",
                                // DINERS CLUB - USA & CANADA
                                "{54dd}-{dddd}-{dddd}-{dddl}",
                                // DISCOVER
                                "{64d(4-9)d}-{dddd}-{dddd}-{dddl}",
                                "{65dd}-{dddd}-{dddd}-{dddl}",
                                "{6011}-{dddd}-{dddd}-{dddl}",
                                "{622d(1-9)}-{dddd}-{dddd}-{dddl}",
                                // INSTAPAYMENT
                                "{63d(7-9)d}-{dddd}-{dddd}-{dddl}",
                                // JCB
                                "{35d(2-8)d}-{dddd}-{dddd}-{dddl}",
                                // LASER
                                "{6304}-{dddd}-{dddd}-{dddd???}",
                                "{6706}-{dddd}-{dddd}-{dddd???}",
                                "{6771}-{dddd}-{dddd}-{dddd???}",
                                "{6709}-{dddd}-{dddd}-{dddd???}",
                                // MAESTRO
                                "{5018}-{dddd}-{dddd}-{dddd???}",
                                "{5020}-{dddd}-{dddd}-{dddd???}",
                                "{5038}-{dddd}-{dddd}-{dddd???}",
                                "{5893}-{dddd}-{dddd}-{dddd???}",
                                "{6304}-{dddd}-{dddd}-{dddd???}",
                                "{6759}-{dddd}-{dddd}-{dddd???}",
                                "{6761}-{dddd}-{dddd}-{dddd???}",
                                "{6762}-{dddd}-{dddd}-{dddd???}",
                                "{6763}-{dddd}-{dddd}-{dddd???}",
                                // MASTERCARD
                                "{5d(1-5)dd}-{dddd}-{dddd}-{dddl}",
                                "{5d(1-5)dd}-{dddd}-{dddd}-{ddddl}",
                                "{5d(1-5)dd}-{dddd}-{dddd}-{dddddl}",
                                "{5d(1-5)dd}-{dddd}-{dddd}-{ddddddl}",
                                // VISA
                                "{4ddd}-{dddd}-{dddd}-{l}",
                                "{4ddd}-{dddd}-{dddd}-{dl}",
                                "{4ddd}-{dddd}-{dddd}-{ddl}",
                                "{4ddd}-{dddd}-{dddd}-{dddl}",
                                // Visa Electron
                                "{4026}-{dddd}-{dddd}-{dddl}",
                                "{4175}-{00dd}-{dddd}-{dddl}",
                                "{4508}-{dddd}-{dddd}-{dddl}",
                                "{4844}-{dddd}-{dddd}-{dddl}",
                                "{4913}-{dddd}-{dddd}-{dddl}",
                                "{4917}-{dddd}-{dddd}-{dddl}",
                            ]
                        }
                    ];
                    
                    elBtnPatterns.onclick = function() {
                        showPatterns();
                    };
                    elBtnCheck.onclick = function ( evt ) {
                        var allFine = true;

                        for( var l = creationInfo.length; l--; ) {
                            if ( creationInfo[l].instance.intact() != true ) {
                                allFine = false;
                            }
                        }

                        if ( allFine ) {
                            elBtnCheck.className = 'validate';
                        }
                        else {
                            elBtnCheck.className = 'error';   
                            evt.preventDefault ? evt.preventDefault() : (evt.returnValue = true);
                        }

                    };
                    chkUnderline.onchange = function(){
                        createChuanr();
                    };
                    createChuanr();


                    isDebug && require(['./src/util', './src/shim/oninput', './src/shim/console'], 
                        function( util, InputObserver, console ){
                        // for testing
                        var oninput = new InputObserver;
                        oninput.observe(elInput);
                        oninput.oninput = function(){
                            console.log('xoninput "' + elInput.value + '"');
                        };
                        util.addListener(elInput, 'keydown', function(evt){
                            console.log('onkeydown: keyCode', evt.keyCode);
                        });
                        util.addListener(elInput, 'keypress', function(evt){
                            console.log('onkeypress: charCode', evt.charCode || evt.keyCode);
                        });
                        util.addListener(elInput, 'input', function(evt){
                            console.log('oninput "' + elInput.value + '"');
                        });
                        util.addListener(elInput, 'propertychange', function(evt){
                            console.log('onpropertychange', evt.propertyName);
                        });
                        util.addListener(elInput, 'keyup', function(evt){
                            console.log('onkeyup "' + evt.keyCode + '"');
                        });
                        var MutationObserver = window.MutationObserver || window.webkitMutationObserver;
                        if ( MutationObserver ) {
                            var observer = new MutationObserver(function(mutations){
                                mutations.forEach(function(mutation){
                                    console.log('Mutation: ' , mutation);
                                });
                            })
                            observer.observe(elInput, { attributes: true, childList: true, characterData: true, subtree: true, attributeOldValue: true });
                            // observer.disconnect();
                        }
                    });
                });
            });
        });
    </script>
    <a href="https://github.com/normanzb/chuanr"><img style="position: absolute; top: 0; right: 30px; border: 0;" src="https://github.com/jamesflorentino/fork-ribbons/raw/master/ribbons/orange-black.png" alt="Fork me on GitHub"></a>
</body>
</html>