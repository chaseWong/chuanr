/* http://github.com/normanzb/ */!function(){var a,b,c,d=new Function("return this")(),e=d.define||function(a){var b=a();"undefined"!=typeof module&&(module.exports=b)||(d.Chuanr=b)};if(function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){return n.apply(d,v.call(arguments,0).concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("../node_modules/almond/almond",function(){}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("shim/../../lib/boe/src/boe/util",[],function(){var a=Function("return this")(),b=a.Object.prototype,c=a.Array.prototype,d=a.Function.prototype,e="function",f={mixinAsStatic:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=f.bind.call(d.call,b[c]));return a},type:function(a){var c=b.toString.call(a),d=c.indexOf("]");return c.substring(8,d)},mixin:function(a,b,c){null==b&&(b=a,a={});for(var d in b)b.hasOwnProperty(d)&&(a[d]=typeof c==e?c(d,b[d]):b[d]);return a},bind:function(a){var b=c.slice,d=this,e=b.call(arguments);return e.shift(),function f(){return this instanceof f&&(a=this),d.apply(a,e.concat(b.call(arguments)))}},slice:function(a){return c.slice.call(a)},g:a};return f}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("shim/console",["../../lib/boe/src/boe/util"],function(a){function b(){}function c(a){n.log&&n.log.call(g,a),j=j+"\n"+a}function d(){return this.log.apply(this,arguments)}function e(b,c){if(c>>>=0,c>>>0>=i)return"...";if(type=a.type(b),str="","Object"==type){str="{";for(var d in b)str+='"'+d+'" : '+e(b[d],c+1)+",";str+="}"}else str="Array"==type?"["+b.toString()+"]":"Undefined"==type||"Null"==type?type:b.toString();return str}function f(b){return function(){for(var c=a.slice(arguments),d=0;d<c.length;d++)c[d]=e(c[d]);return Function.prototype.call.call(b,this,c.join(" "))}}var g,h,i=3,j="",k=navigator.userAgent.toUpperCase(),h=k.indexOf("MSIE")>0||k.indexOf("TRIDENT")>0,l=k.indexOf("OS 5_0 LIKE MAC OS X")>0,m={log:l?c:b,error:d,warn:d,debug:d},n={},g=window.console;for(var o in m)m.hasOwnProperty(o)&&((null==g[o]||l)&&(n[o]=g[o],g[o]=m[o]),(h||l)&&(g[o]=f(g[o])));return g.hr=function(){g.log("=======================================")},g.logs=function(){return j},g}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("../lib/boe/src/boe/util",[],function(){var a=Function("return this")(),b=a.Object.prototype,c=a.Array.prototype,d=a.Function.prototype,e="function",f={mixinAsStatic:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=f.bind.call(d.call,b[c]));return a},type:function(a){var c=b.toString.call(a),d=c.indexOf("]");return c.substring(8,d)},mixin:function(a,b,c){null==b&&(b=a,a={});for(var d in b)b.hasOwnProperty(d)&&(a[d]=typeof c==e?c(d,b[d]):b[d]);return a},bind:function(a){var b=c.slice,d=this,e=b.call(arguments);return e.shift(),function f(){return this instanceof f&&(a=this),d.apply(a,e.concat(b.call(arguments)))}},slice:function(a){return c.slice.call(a)},g:a};return f}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("../lib/boe/src/boe/String/trim",["../util"],function(a){var b=a.g.String.prototype;return b.trim||function(){var a="\\s",b=new RegExp("(^"+a+"*)|("+a+"*$)","g");return this.replace(b,"")}}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("Formatter",["./shim/console","../lib/boe/src/boe/String/trim"],function(a,b){function c(){var b,c,d,e,f=!1,g=this._cache;a.log('Start Formating: "'+g+'"');for(var h=0;h<this.patterns.length;h++)if(b=this.patterns[h],c=b.apply(g)){if(a.log("  ",b+"",c.counts),c.matched){d=c,e=b,f=!0;break}(null==d||c.counts.matched>d.counts.matched)&&(d=c,e=b)}return null!=e&&d?(a.log("Best Matching Pattern: ",e.toString(),d),this._current={pattern:e,result:d,input:g},this._current):null}function d(a){if(null==a||a.length>>>0<=0)throw e;this._cache="",this._current=null,this.patterns=a,this._undo=[]}var e="No pattern specified",f=d.prototype;return f.input=function(a){var b,c=this._cache,d="";"string"==typeof a&&(a={key:0,"char":a.charCodeAt(0),del:!1,back:!1,caret:{begin:c.length,end:c.length}}),b={begin:a.caret.begin,end:a.caret.end},a.caret.begin==a.caret.end&&(a.del?b.end+=1:a.back&&(b.begin-=1)),null!=a["char"]&&(d=String.fromCharCode(a["char"])),c=c.substring(0,b.begin)+d+c.substring(b.end,c.length),this._undo.push(this._cache),this._cache=c},f.output=function(){return c.call(this)},f.undo=function(){return this._undo.length<=0?null:(this._cache=this._undo.pop(),c.call(this))},f.extract=function(c){var d,e=null;if(this._current&&this._current.pattern)try{e=this._current.pattern.extract(c),e.pattern=this._current.pattern}catch(f){a.log("Best bet extraction failed, will try the others...")}for(var g=this.patterns.length;g--;){try{d=this.patterns[g].extract(b.call(c))}catch(f){continue}(null==e||d.length>e.length)&&(e=d,e.pattern=this.patterns[g])}return e},f.index=function(){return this._current.pattern.index()},f.reset=function(a){return null==a&&(a=""),this._undo.push(this._cache),this._cache=a,this._current=null,c.call(this)},d}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("PatternFunction/digit",[],function(){function a(a){return null==a||null==a.prev||1!=d.test(a.prev)?!0:!1}var b="Not a correct parameter format",c="Expect the range to be 0-9",d=/[0-9]/,e=/[^0-9\-]/,f=function(d,f,g){if("="==f)return a(g)?!1:d==g.prev;if("+"==f.charAt(0)||"-"==f.charAt(0)){if(a(g))return!1;if(1==f.length&&(f+="1"),Math.abs(f>>0)>=10)throw new Error(c);return d==1*g.prev+(f>>0)}if((null==f||0==f&&"0"!==f)&&(f="0-9"),e.test(f))throw new Error(b);return new RegExp("^["+f+"]$").test(d)};return f}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("PatternFunction/alphabet",[],function(){function a(a){return null==a||null==a.prev||1!=e.test(a.prev)?!0:!1}var b="Not a correct parameter format",c="Expect the range to be a-zA-Z",d="a-zA-Z",e=new RegExp("["+d+"]"),f=new RegExp("[^"+d+"-]"),g=function(e,g,h){if("="==g)return a(h)?!1:e==h.prev;if("+"==g.charAt(0)||"-"==g.charAt(0)){if(a(h))return!1;if(1==g.length&&(g+="1"),Math.abs(g>>0)>=10)throw new Error(c);return e.charCodeAt(0)==(1*h.prev+(g>>0)).charCodeAt(0)}if((null==g||0==g&&"0"!==g)&&(g=d),f.test(g))throw new Error(b);return new RegExp("^["+g+"]$").test(e)};return g}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("../lib/boe/src/boe/Object/clone",["../util"],function(a){function b(h){var i;if(g in this)return this[g];f.push(this),i=typeof this==c?window.eval("true?("+e.toString.call(this)+"):false"):"Array"==a.type(this)?[]:{},this[g]=i;for(var j in this)if(0!=this.hasOwnProperty(j)&&j!=g){var k=this[j];i[j]=!h||typeof k!=d&&typeof k!=c?k:b.call(k,h)}if(f.pop()!=this)throw"boe.Object.shadow: stack corrupted.";return delete this[g],i}var c="function",d="object",e=a.g.Function.prototype,f=[],g="__boeObjectClone_Traversed";return b}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("PatternConstant",[],function(){return{MODE_CONSTANT:1,MODE_FUNCTION:2,MODE_PARAMETER:4}}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("PatternIndexQuery",["./PatternConstant"],function(a){function b(){var a,b,c,f=this._query,g=this._target,h=this._pattern.items;if(null==f||null==g)return this;if(f["function"]&&null!=f["function"].index&&"pattern"==g){a=-1;for(var i=0;i<h.length;i++)if(b=h[i],b.type==d&&(a++,c=i,a==f["function"].index))return i;return f["function"].index==a+1?c+1:-1}if(f.pattern&&null!=f.pattern.index&&"function"==g){if(a=0,f.pattern.index<0)return-1;for(var i=0;i<h.length&&f.pattern.index>0;i++)if(b=h[i],b.type==d&&a++,i==f.pattern.index-1)return a;return a}throw e}function c(a){this._pattern=a,this._target="pattern"}var d=(a.MODE_CONSTANT,a.MODE_FUNCTION),e=(a.MODE_PARAMETER,"Parameter not acceptable."),f=c.prototype;return f.by=function(a){return this._query=a,b.call(this)},f.of=function(a){return this._target=a,this},c}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("Pattern",["./PatternFunction/digit","./PatternFunction/alphabet","../lib/boe/src/boe/Object/clone","./PatternIndexQuery","./PatternConstant"],function(a,b,c,d,e){function f(a,b){return t+": "+a+":"+b}function g(a,b){return u+": "+a+":"+b}function h(){return this.result}function i(a){if(a==m)return n;if(a==n)return m;if(a==o)return p;if(a==p)return o;throw new Error(v)}function j(a){for(var b,c,d=this,e=q,g=[],h=0;h<a.length;h++)if(b=a.charAt(h),e==q&&b==m)g.push({"char":b,mode:e}),e=r;else if(e==r&&b==n&&g[g.length-1]["char"]==m)c=g.pop(),e=c.mode;else if(e==r&&b==o)g.push({"char":b,mode:e}),e=s;else if(e==s&&b==p&&g[g.length-1]["char"]==o)c=g.pop(),e=c.mode;else if(e==q)d.items.push({type:e,value:b});else if(e==r)d.items.push({type:e,value:b,param:""});else{var j=d.items[d.items.length-1];if(j.type!=r)throw new Error(f("Expect a function pattern",h-1));j.param+=b}if(g.length>0)throw new Error(f("Expect a '"+i(g[g.length-1]["char"])+"'",h-1))}function k(b){return function(c){return a(c,b+"")}}function l(a){this.items=[],this.pattern=a,this._query=null,j.call(this,a)}var m="{",n="}",o="(",p=")",q=e.MODE_CONSTANT,r=e.MODE_FUNCTION,s=e.MODE_PARAMETER,t="Syntax error",u="Runtime error",v="Not a tag.",w="Not a formatted string.",x=l.prototype;x.apply=function(a,b){var d,e,f,i,j,k,m,n,o=[],p="",s=!0,t=0;for(f=a.toString(),i=c.call(this.items,!0),d=0;d<i.length;d++)j=i[d],j.type==r&&o.push(j);for(e=b?o.length:f.length,a.length>o.length&&(s=!1),d=0;e>d&&d<o.length;d++)if(j=o[d],n=f.charAt(d),j.type==r){if(k=l.functions[j.value],null==k)throw new Error(g('Function "'+j.value+'"" was not available.',d));m={prev:f.charAt(d-1)};try{if(k.call(null,n,j.param,m)===!1){s=!1;break}}catch(u){throw new Error(g(u.message,d))}t++,j.value=n,j.type=q}for(d=0;d<i.length;d++)j=i[d],p+=j.type==q?j.value:" ";return{result:p,matched:s,counts:{total:e,matched:t},toString:h}},x.extract=function(a){if(a.length>this.items.length)throw w;for(var b,c,d,e,f=[],g=this.items,i=0;i<a.length;i++)if(b=g[i],e=a.charAt(i),b.type==r){if(c=l.functions[b.value],null==c)throw w;if(" "==e)continue;if(d={prev:a.charAt(i-1)},0==c.call(null,e,b.param,d))throw w;f.push({result:e,index:{formatted:i,original:f.length},toString:h})}else{if(b.type!=q)throw w;if(e!=b.value)throw w}return f.toString=function(){return this.join("")},f},x.index=function(a){var b=new d(this,a);return b},x.toString=function(){return this.pattern},l.functions={d:a,a:b};for(var y=10;y--;)l.functions[y]=k(y);return l.parse=function(a){var b=new l(a);return b},l}),"function"!=typeof c&&module)var c=b("amdefine")(module);if(c("util",[],function(){var a={},b="undefined"!=typeof navigator?navigator.userAgent:null,c=/iphone/i.test(b);return a.isBetween=function(a,b){return b.sort(function(a,b){return a-b}),a>b[0]&&a<b[1]},a.addListener=function(a,b,c){return"undefined"!=typeof a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},a.preventDefault=function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1},a.getClip=function(a){return a.clipboardData?a.clipboardData.getData("Text"):window.clipboardData?window.clipboardData.getData("Text"):void 0},a.isDelKey=function(a){return 46===a||c&&127===a},a.isBackSpaceKey=function(a){return 8===a},a.isSpecialKey=function(a){var b={9:"tab",13:"enter",35:"end",36:"home",37:"leftarrow",38:"uparrow",39:"rightarrow",40:"downarrow",116:"F5"};return b[a]},a.isModifier=function(a){return a.ctrlKey||a.altKey||a.metaKey},a.isAcceptableKeyCode=function(b){return b>=48&&57>=b||b>=65&&90>=b||b>=96&&105>=b||a.isDelKey(b)||a.isBackSpaceKey(b)?!0:!1},a.isMovementKeyCode=function(a){return a>=37&&40>=a||9==a?!0:!1},a}),c("caret",["require"],function(){var a={};return a.get=function(a){if("number"==typeof a.selectionStart)return{begin:a.selectionStart,end:a.selectionEnd};var b=document.selection.createRange();if(b&&b.parentElement()==a){var c=a.createTextRange(),d=a.createTextRange(),e=a.value.length;return c.moveToBookmark(b.getBookmark()),d.collapse(!1),c.compareEndPoints("StartToEnd",d)>-1?{begin:e,end:e}:{begin:-c.moveStart("character",-e),end:-c.moveEnd("character",-e)}}return{begin:0,end:0}},a.set=function(a,b){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}},a}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("differ",[],function(){var a={diff:function(a,b){var c,d,e,f,g,h,i,j=-1,k=-2,l=0;for(a.length>b.length?(h=a,i=b):(h=b,i=a,l=1),d=0;d<h.length;d++)if(c=h.charAt(d),c!=i.charAt(d)){j=d;break}for(d=h.length;d--;)if(c=h.charAt(d),j>=d||c!=i.charAt(i.length-(h.length-d))){k=d;break}if(f={begin:j,end:k+1},g={begin:j,end:i.length-(h.length-k)+1},e={deletion:{text:h.substring(f.begin,f.end),caret:f},insertion:{text:i.substring(g.begin,g.end),caret:g}},l){var m=e.deletion;e.deletion=e.insertion,e.insertion=m}return e}};return a}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("../lib/boe/src/boe/Function/bind",["../util"],function(a){var b=a.g.Function.prototype;return b.bind||a.bind}),c("../lib/cogs/src/cogs/noop",[],function(){return function(){}}),c("../lib/cogs/src/cogs/observable",["./noop"],function(a){function b(){this.ref=null,this.next=null}function c(){return new b}function d(a){if("[object function]"!==Object.prototype.toString.call(a).toLowerCase())throw new Error("hookee is not a function")}function e(a){return d(a),this.cur.next=c(),this.cur=this.cur.next,this.cur.ref=a,!0}function f(a){d(a);for(var b=this.head,c=null;null!=b.next;)if(c=b,b=b.next,b.ref===a||null==a)return c.next=b.next,null==b.next&&(this.cur=c),b.ref=null,!0;return!1}function g(a){var b=this,c=function(){f.call(b,c),a.apply(this,arguments)};e.call(b,c)}function h(){for(var a=Array.prototype.slice.call(arguments,1),b=arguments[0],c=this.head,d=null,e=null,f=null;null!=c.next;)if(d=c,c=c.next,null!=c.ref){e=null;try{e=c.ref.apply(b,a)}catch(g){setTimeout(function(){throw g},0)}null!=e&&(f=e)}return f}function i(b){var d=b?b:function(){return d.invoke.apply(this,arguments)};return d.head=c(),d.head.ref=a,d.cur=d.head,d.hook=e,d.once=g,d.unhook=f,d.invoke=function(){var a=Array.prototype.slice.call(arguments);a.unshift(this),h.apply(d,a)},d}return i.EventLinkBox=b,i}),c("../lib/cogs/src/cogs/event",["./observable"],function(a){function b(){var b=a();b.onHook=a(),b.onUnhook=a();var c=b.hook,d=b.once;b.hook=function(a){return b.onHook(this,a)===!1?!1:c.apply(this,arguments)},b.once=function(a){return b.onHook(this,a)===!1?!1:d.apply(this,arguments)};var e=b.unhook;return b.unhook=function(a){return b.onUnhook(this,a)===!1?!1:e.apply(this,arguments)},b}function c(a,c){var d=a.charAt(0).toUpperCase()+a.substr(1),e=this[f+d];if(e||(e=b(),this[f+d]=e),!e.hook)throw"The member name '"+a+"' is occupied.";e.hook(c)}function d(b,c){if(b){var e=b.charAt(0).toUpperCase()+b.substr(1),g=this[f+e];if(g){if(!g.unhook)throw"The member name '"+b+"' might be over written.";g.unhook(c)}}else for(var h in this)0==h.indexOf(f)&&this[h].head instanceof a.EventLinkBox&&d(h.substr(2))}function e(a){var b,c=[a.charAt(0).toUpperCase(),a.substr(1)].join(""),d=this[f+c];d&&(b=Array.prototype.slice.call(arguments,1),d.apply(this,b))}var f="on";return b.onFunc=c,b.offFunc=d,b.emitFunc=e,b}),c("../lib/cogs/src/cogs/emittable",["./event"],function(a){function b(b){return b.on=a.onFunc,b.off=a.offFunc,b.emit=a.emitFunc,b}return b(b.prototype),b}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);if(c("shim/oninput",[],function(){function a(){this._old="",this.oninput=function(){}}var b="input",c=function(){function a(a){if(a.setAttribute("oninput","return"),"function"==typeof a.oninput)return!0;try{var c=document.createEvent("KeyboardEvent"),d=!1,e=function(a){d=!0,a.preventDefault(),a.stopPropagation()};return c.initKeyEvent("keypress",!0,!0,window,!1,!1,!1,!1,0,"e".charCodeAt(0)),document.body.appendChild(a),a.addEventListener(b,e,!1),a.focus(),a.dispatchEvent(c),a.removeEventListener(b,e,!1),document.body.removeChild(a),d}catch(c){}}var c=document.createElement(b);return"oninput"in c||a(c)}(),d=a.prototype;return d.observe=function(a){function d(){a.value!=e._old&&(e._old=a.value,e.oninput())}if(null==a||a.tagName.toLowerCase()!=b)throw"Target input element must be specified.";var e=this;if(a.attachEvent)e._old=a.value,a.attachEvent("onpropertychange",d),a.attachEvent("onfocus",function(){document.attachEvent("onselectionchange",d)}),a.attachEvent("onblur",function(){document.detachEvent("onselectionchange",d)});else{if(!c)throw"Something wrong, should never goes to here.";a.addEventListener(b,function(){e.oninput()},!1)}},a}),"function"!=typeof c&&"undefined"!=typeof module)var c=b("amdefine")(module);c("Chuanr",["./Formatter","./Pattern","./util","./caret","./differ","../lib/boe/src/boe/Function/bind","../lib/boe/src/boe/String/trim","../lib/boe/src/boe/Object/clone","../lib/boe/src/boe/util","../lib/cogs/src/cogs/emittable","../lib/cogs/src/cogs/event","./shim/oninput","./shim/console"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b){var c,d;try{m.log("Do Extraction of '"+a+"'"),d=this.formatter.extract(a),null!=d&&(c=g.call(d+""),m.log("Exracted",c))}catch(e){c=null}return null==c&&m.log("Extraction failed "),b&&null!=c&&(m.log("Caret before update: ",b),b.begin=this.formatter.index().of("function").by({pattern:{index:b.begin}}),b.end=this.formatter.index().of("function").by({pattern:{index:b.end}}),(b.begin<0||b.begin>c.length)&&(b.begin=c.length),(b.end<0||b.end>c.length)&&(b.end=c.length),m.log('Original input extracted: "'+c+'"',"Updated caret: ",b)),0==c&&(this._isFormatted=!1),c}function o(a,b){var c,d,f,g,h,i,j,k=!1;return m.log("Not raw data, need some sophisicated logic to figure out"),c=this._untouched?this._untouched.result+"":"",differ=e.diff(c,a),m.log("Differ '"+c+"':'"+a+"'",differ),extraction=this.formatter.extract(c),null==extraction?d:(f=extraction+"",isSpaceDeletion=differ.insertion.caret.begin==differ.insertion.caret.end&&b.begin<extraction.pattern.items.length&&2==extraction.pattern.items[b.begin].type&&" "==differ.deletion.text,k=differ.insertion.caret.begin==differ.insertion.caret.end&&differ.deletion.text.length>0&&1==extraction.pattern.items[b.begin].type,g=extraction.pattern.index().of("function").by({pattern:{index:differ.deletion.caret.begin}}),h=extraction.pattern.index().of("function").by({pattern:{index:differ.deletion.caret.end}}),(isSpaceDeletion||k)&&(m.log("User deleted "+differ.deletion.text.length+"space/constant(s)"),g=extraction.pattern.index().of("function").by({pattern:{index:b.begin}})-(k?1:0)),i=f.substring(0,g),j=f.substring(h,f.length+1),a=i+differ.insertion.text+j,null!=b&&(isSpaceDeletion||k?(b.begin=g,b.end=b.begin,b.type=2):(b.begin=h+differ.insertion.text.length-differ.deletion.text.length,b.end=b.begin,b.type=2)),m.log("Raw Input",a,b),d=a)}function p(a,b,c){var d;return m.log("Try to be smart, figure out what the user actually want to input"),m.log("Speculation Step 1. Try Extract"),d=n.call(this,this._el.value,null),null==d?(m.log("Failed to extract."),m.log("Speculation Step 2. Try filter out puncuation and spaces."),d=a.replace(/\W/g,""),0!=d&&(m.log("Speculation Step 2.5. Comparing to get differ"),differ=e.diff(this._untouched?g.call(this._untouched.result+""):"",a),m.log("Differ",differ),a=g.call(d))):(m.log("Extracted, use extracted string."),a=g.call(d),c.type=1),m.log('Speculation Done, Result "'+a+'"'),a}function q(a){return 1==this._requireHandleKeyUp&&this._keyCode==a.keyCode?(m.log("Continuous Key Down Prevented"),void c.preventDefault(a)):0==c.isAcceptableKeyCode(a.keyCode)||c.isModifier(a)?(0==c.isMovementKeyCode(a.keyCode)&&0==c.isModifier(a)&&(m.log("Key Down Prevented"),c.preventDefault(a)),this._requireHandlePress=!1,void(this._requireHandleInput=!1)):(m.hr(),this._keyCode=a.keyCode,this._caret=d.get(this._el),this._charCode=null,this._isFormatted&&""!==this._el.value&&(this._el.value=n.call(this,this._el.value,this._caret)),0==c.isDelKey(a.keyCode)&&0==c.isBackSpaceKey(a.keyCode)&&(this._requireHandlePress=!0),this._requireHandleInput=!0,void(this._requireHandleKeyUp=!0))}function r(a){0!=this._requireHandlePress&&(this._charCode=a.keyCode||a.charCode,this._requireHandlePress=!1)}function s(){this._requireHandleInput&&1!=this._requireHandlePress?(m.log("Input Type: Single: ",String.fromCharCode(this._charCode)),u.call(this,{key:this._keyCode,"char":this._charCode,del:c.isDelKey(this._keyCode),back:c.isBackSpaceKey(this._keyCode),caret:this._caret})):(m.hr(),m.log("Input Type: Batch: ",this._el.value),u.call(this)),this._requireHandlePress=!1,this._requireHandleInput=!1}function t(){1==this._requireHandleInput&&(m.log("Compulsorily call into onInput"),s.call(this)),this._requireHandleKeyUp=!1}function u(a){var b,c=this,e={begin:0,end:0,type:0},f=!0,g=!1,h=a?1:0;for(h?(e=a.caret,this.formatter.input(a),b=this.formatter.output(),0==b.result.matched?f=!1:(a.del||a.back)&&(f=!1,e.begin>0&&(e.begin-=1),e.end>0&&(e.end-=1))):(a=this._el.value,e=d.get(this._el),b=this.formatter.reset(a),b.result.matched?e.type=2:(a=o.call(this,a,e),b=this.formatter.reset(a),0==b.result.matched&&1==this.config.speculation.batchinput&&(a=p.call(this,a,b,e),b=this.formatter.reset(a))),f=!1);0==b.result.matched;){if(g=b,b=this.formatter.undo(),m.log("Failed to format, undo."),null==b){m.log("Tried to undo, but failed.");break}e.begin=n.call(this,b.result.toString(),null).length,e.end=e.begin,f=!1,e.type=2}if(null==b)throw'Boom, "format" is null, this should never happen.';m.log("Final Format",b.result.toString()),this._untouched=b,this._el.value=b.result,m.log("Caret before format: ",e),m.log("Move caret? ",f),h?(e.begin=this.formatter.index().of("pattern").by({"function":{index:e.begin+(f?1:0)}}),e.begin<0&&(e.begin=this._el.value.length)):2===e.type?e.begin=this.formatter.index().of("pattern").by({"function":{index:e.begin}}):1===e.type,m.log("Caret after format: ",e),d.set(this._el,e.begin),setTimeout(function(){d.get(c._el)!=e.begin&&d.set(c._el,e.begin)}),this._isFormatted=0!=b.result?!0:!1,g?this.onPrevented.invoke(g):this.onResumed.invoke(b)}function v(a){this.patterns=[],this.formatter=null,this.oninput=null,this.config=h.call(x,!0),i.mixin(this.config,a),this._el=null,this._requireHandlePress=!1,this._requireHandleInput=!1,this._requireHandleKeyUp=!1,this._keyCode=null,this._charCode=null,this._caret=null,this._untouched=null,this._isFormatted=!1,this.onPrevented=k(),this.onResumed=k(),j(this)}var w={Formatter:a,Pattern:b,InputObserver:l},x={speculation:{batchinput:!0}},y=v.prototype;return y.roast=function(a,b){if(null==a||"INPUT"!=a.tagName.toUpperCase())throw"Target input element must be specified.";this._el=a;for(var d=0;d<b.length;d++)this.patterns.push(w.Pattern.parse(b[d]));this.formatter=new w.Formatter(this.patterns),this.oninput=new l,this.oninput.observe(a),this.oninput.oninput=f.call(s,this),c.addListener(a,"keydown",f.call(q,this)),c.addListener(a,"keypress",f.call(r,this)),c.addListener(a,"keyup",f.call(t,this)),""!=this._el.value&&s.call(this)},y.intact=function(){if(null==this._untouched||""==this._untouched)return!1;var a=this._untouched.pattern.apply(this._untouched.input,!0);return a.matched},v.setting=w,v}),e(function(){return b("Chuanr")})}();