/* http://github.com/normanzb/ */!function(){var a,b,c,d=new Function("return this")(),e=d.define||function(a){var b=a();"undefined"!=typeof module&&(module.exports=b)||(d.chuanr=b)};!function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){return n.apply(d,v.call(arguments,0).concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("../node_modules/almond/almond",function(){}),c("shim/console",[],function(){var a=function(){},b=window.console||{log:a,error:a,warn:a,debug:a};return b.hr=function(){b.log("=======================================")},b}),c("Formatter",["./shim/console"],function(a){function b(){var b,c,d,e,f=!1,g=this._cache;a.log('Start Formating: "'+g+'"');for(var h=0;h<this.patterns.length;h++)if(b=this.patterns[h],c=b.apply(g)){if(c.matched){d=c,e=b,f=!0;break}(null==d||c.counts.matched>d.counts.matched)&&(d=c,e=b)}return null!=e&&d?(a.log("Best Matching Pattern: ",e.toString(),d),this._current={pattern:e,result:d},this._current):null}function c(a){if(null==a||a.length>>>0<=0)throw d;this._cache="",this._current=null,this.patterns=a,this._undo=[]}var d="No pattern specified",e=c.prototype;return e.input=function(a){var b=this._cache,c={begin:a.caret.begin,end:a.caret.end},d="";a.caret.begin==a.caret.end&&(a.del?c.end+=1:a.back&&(c.begin-=1)),null!=a.char&&(d=String.fromCharCode(a.char)),b=b.substring(0,c.begin)+d+b.substring(c.end,b.length),this._undo.push(this._cache),this._cache=b},e.output=function(){return b.call(this)},e.undo=function(){return this._cache=this._undo.pop(),b.call(this)},e.extract=function(a){return this._current.pattern.extract(a)},e.index=function(){return this._current.pattern.index()},e.reset=function(a){null==a&&(a=""),this._undo.push(this._cache),this._cache=a,this._current=null,b.call(this)},c}),c("PatternFunction/digit",[],function(){var a=function(a,b){return(null==b||0==b)&&(b="0-9"),new RegExp("^["+b+"]$").test(a)};return a}),c("../lib/boe/src/boe/util",[],function(){var a=Function("return this")(),b=a.Object.prototype,c=a.Array.prototype,d=a.Function.prototype,e="function",f={mixinAsStatic:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=f.bind.call(d.call,b[c]));return a},type:function(a){var c=b.toString.call(a),d=c.indexOf("]");return c.substring(8,d)},mixin:function(a,b,c){null==b&&(b=a,a={});for(var d in b)b.hasOwnProperty(d)&&(a[d]=typeof c==e?c(d,b[d]):b[d]);return a},bind:function(a){var b=c.slice,d=this,e=b.call(arguments);return e.shift(),function f(){return this instanceof f&&(a=this),d.apply(a,e.concat(b.call(arguments)))}},slice:function(a){return c.slice.call(a)},g:a};return f}),c("../lib/boe/src/boe/Object/clone",["../util"],function(a){function b(h){var i;if(g in this)return this[g];f.push(this),i=typeof this==c?window.eval("true?("+e.toString.call(this)+"):false"):"Array"==a.type(this)?[]:{},this[g]=i;for(var j in this)if(0!=this.hasOwnProperty(j)&&j!=g){var k=this[j];i[j]=!h||typeof k!=d&&typeof k!=c?k:b.call(k,h)}if(f.pop()!=this)throw"boe.Object.shadow: stack corrupted.";return delete this[g],i}var c="function",d="object",e=a.g.Function.prototype,f=[],g="__boeObjectClone_Traversed";return b}),c("PatternConstant",[],function(){return{MODE_CONSTANT:1,MODE_FUNCTION:2,MODE_PARAMETER:4}}),c("PatternIndexQuery",["./PatternConstant"],function(a){function b(){var a,b=this._query,c=this._target,f=-1,g=this._pattern.items;if(null==b||null==c)return this;if(b.function&&null!=b.function.index&&"pattern"==c){for(var h=0;h<g.length;h++)if(a=g[h],a.type==d&&(f++,f==b.function.index))return h;return-1}if(b.pattern&&null!=b.pattern.index&&"function"==c){for(var h=0;h<g.length;h++)if(a=g[h],a.type==d&&f++,h==b.pattern.index)return f;return-1}throw e}function c(a){this._pattern=a,this._target="pattern"}var d=(a.MODE_CONSTANT,a.MODE_FUNCTION),e=(a.MODE_PARAMETER,"Parameter not acceptable."),f=c.prototype;return f.by=function(a){return this._query=a,b.call(this)},f.of=function(a){return this._target=a,this},c}),c("Pattern",["./PatternFunction/digit","../lib/boe/src/boe/Object/clone","./PatternIndexQuery","./PatternConstant"],function(a,b,c,d){function e(a,b){return s+": "+a+":"+b}function f(a,b){return t+": "+a+":"+b}function g(){return this.result}function h(a){if(a==l)return m;if(a==m)return l;if(a==n)return o;if(a==o)return n;throw new Error(u)}function i(a){for(var b,c,d=this,f=p,g=[],i=0;i<a.length;i++)if(b=a.charAt(i),f==p&&b==l)g.push({"char":b,mode:f}),f=q;else if(f==q&&b==m&&g[g.length-1].char==l)c=g.pop(),f=c.mode;else if(f==q&&b==n)g.push({"char":b,mode:f}),f=r;else if(f==r&&b==o&&g[g.length-1].char==n)c=g.pop(),f=c.mode;else if(f==p)d.items.push({type:f,value:b});else if(f==q)d.items.push({type:f,value:b,param:""});else{var j=d.items[d.items.length-1];if(j.type!=q)throw new Error(e("Expect a function pattern",i-1));j.param+=b}if(g.length>0)throw new Error(e("Expect a '"+h(g[g.length-1].char)+"'",i-1))}function j(b){return function(c){return a(c,b+"")}}function k(a){this.items=[],this.pattern=a,this._query=null,i.call(this,a)}var l="{",m="}",n="(",o=")",p=d.MODE_CONSTANT,q=d.MODE_FUNCTION,r=d.MODE_PARAMETER,s="Syntax error",t="Runtime error",u="Not a tag.",v="Not a formatted string.",w=k.prototype;w.apply=function(a,c){var d,e,h,i,j,l,m=[],n="",o=!0,r=0;for(h=a.toString(),i=b.call(this.items,!0),d=0;d<i.length;d++)j=i[d],j.type==q&&m.push(j);for(e=c?m.length:h.length,r=e,a.length>m.length&&(o=!1),d=0;e>d&&d<m.length;d++)if(j=m[d],char=h.charAt(d),j.type==q){if(l=k.functions[j.value],null==l)throw new Error(f('Function "'+j.value+'"" was not available.',d));if(l.call(null,char,j.param)===!1){o=!1,r=d+1;break}j.value=char,j.type=p}for(d=0;d<i.length;d++)j=i[d],n+=j.type==p?j.value:" ";return{result:n,matched:o,counts:{total:e,matched:r},toString:g}},w.extract=function(a){if(a.length!=this.items.length)throw v;for(var b,c=[],d=this.items,e=0;e<d.length;e++){var b=d[e];b.type==q&&c.push({result:a.charAt(e),index:{formatted:e,original:c.length},toString:g})}return c.toString=function(){return this.join("")},c},w.index=function(a){var b=new c(this,a);return b},w.toString=function(){return this.pattern},k.functions={d:a};for(var x=10;x--;)k.functions[x]=j(x);return k.parse=function(a){var b=new k(a);return b},k}),c("util",[],function(){var a={},b="undefined"!=typeof navigator?navigator.userAgent:null,c=/iphone/i.test(b);return a.extend=function(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])a[c]=arguments[b][c];return a},a.addChars=function(a,b,c){return a.substr(0,c)+b+a.substr(c,a.length)},a.removeChars=function(a,b,c){return a.substr(0,b)+a.substr(c,a.length)},a.isBetween=function(a,b){return b.sort(function(a,b){return a-b}),a>b[0]&&a<b[1]},a.addListener=function(a,b,c){return"undefined"!=typeof a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},a.preventDefault=function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1},a.getClip=function(a){return a.clipboardData?a.clipboardData.getData("Text"):window.clipboardData?window.clipboardData.getData("Text"):void 0},a.isUndo=function(){},a.isDelKey=function(a){return 46===a||c&&127===a},a.isBackSpaceKey=function(a){return 8===a},a.isSpecialKey=function(a){var b={9:"tab",13:"enter",35:"end",36:"home",37:"leftarrow",38:"uparrow",39:"rightarrow",40:"downarrow",116:"F5"};return b[a]},a.isModifier=function(a){return a.ctrlKey||a.altKey||a.metaKey},a.isAcceptableKeyCode=function(b){return b>=48&&57>=b||b>=65&&90>=b||b>=96&&105>=b||a.isDelKey(b)||a.isBackSpaceKey(b)?!0:!1},a.isMovementKeyCode=function(a){return a>=37&&40>=a||9==a?!0:!1},a}),c("caret",["require"],function(){var a={};return a.get=function(a){if("number"==typeof a.selectionStart)return{begin:a.selectionStart,end:a.selectionEnd};var b=document.selection.createRange();if(b&&b.parentElement()==a){var c=a.createTextRange(),d=a.createTextRange(),e=a.value.length;return c.moveToBookmark(b.getBookmark()),d.collapse(!1),c.compareEndPoints("StartToEnd",d)>-1?{begin:e,end:e}:{begin:-c.moveStart("character",-e),end:-c.moveEnd("character",-e)}}return{begin:0,end:0}},a.set=function(a,b){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}},a}),c("../lib/boe/src/boe/Function/bind",["../util"],function(a){var b=a.g.Function.prototype;return b.bind||a.bind}),c("../lib/boe/src/boe/String/trim",["../util"],function(a){var b=a.g.String.prototype;return b.trim||function(){var a="\\s",b=new RegExp("(^"+a+"*)|("+a+"*$)","g");return this.replace(b,"")}}),c("Chuanr",["./Formatter","./Pattern","./util","./caret","../lib/boe/src/boe/Function/bind","../lib/boe/src/boe/String/trim","./shim/console"],function(a,b,c,d,e,f,g){function h(a){if(0==c.isAcceptableKeyCode(a.keyCode)||c.isModifier(a))return 0==c.isMovementKeyCode(a.keyCode)&&0==c.isModifier(a)&&a.preventDefault(),this._requireHandlePress=!1,void(this._requireHandleInput=!1);g.hr();var b;this._keyCode=a.keyCode,this._caret=d.get(this._el),this._charCode=null,this.isFormatted&&(b=f.call(this.formatter.extract(this._el.value)),g.log("Caret before update: ",this._caret),this._caret.begin=this.formatter.index().of("function").by({pattern:{index:this._caret.begin}}),this._caret.end=this.formatter.index().of("function").by({pattern:{index:this._caret.end}}),(this._caret.begin<0||this._caret.begin>b.length)&&(this._caret.begin=b.length),(this._caret.end<0||this._caret.end>b.length)&&(this._caret.end=b.length),g.log('Original input extracted: "'+b+'"',"Updated caret: ",this._caret),this._el.value=b),0==c.isDelKey(a.keyCode)&&0==c.isBackSpaceKey(a.keyCode)&&(this._requireHandlePress=!0),this._requireHandleInput=!0}function i(a){0!=this._requireHandlePress&&(this._charCode=a.keyCode||a.charCode,this._requireHandlePress=!1)}function j(){if(this._requireHandleInput&&1!=this._requireHandlePress)g.log("Input Type: Single: ",String.fromCharCode(this._charCode)),k.call(this,{key:this._keyCode,"char":this._charCode,del:c.isDelKey(this._keyCode),back:c.isBackSpaceKey(this._keyCode),caret:this._caret}),this._requireHandlePress=!1,this._requireHandleInput=!1;else{g.hr();var a=this._el.value;g.log("Input Type: Batch: ",a),this.formatter.reset(a),k.call(this)}}function k(a){var b={begin:0,end:0},c=!0;a?(b=a.caret,this.formatter.input(a)):b=d.get(this._el);var e=this.formatter.output();0==e.result.matched?(g.log("Failed to format, undo."),c=!1,e=this.formatter.undo()):this._untouched&&null==a?this._untouched.result.toString().length>this._el.value.length&&(c=!1):a&&(a.del||a.back)&&(c=!1,b.begin-=1,b.end-=1),g.log("Move caret? ",c),null==e.result.toString()&&(g.warn("Revert, this should never happen?"),e=this._untouched),this._untouched=e,g.log("Final Format",e.result.toString(),e),this._el.value=e.result,g.log("Caret before input: ",b),b.begin=this.formatter.index().of("pattern").by({"function":{index:b.begin+(c?1:0)}}),b.begin<0&&(b.begin=this._el.value.length),g.log("Caret after format: ",b),d.set(this._el,b.begin),this.isFormatted=!0}function l(){this.patterns=[],this.formatter=null,this._el=null,this._requireHandlePress=!1,this._requireHandleInput=!1,this._keyCode=null,this._charCode=null,this._caret=null,this._untouched="",this.isFormatted=!1}var m={Formatter:a,Pattern:b},n=l.prototype;return n.roast=function(a,b){null!=this._el,this._el=a;for(var d=0;d<b.length;d++)this.patterns.push(m.Pattern.parse(b[d]));this.formatter=new m.Formatter(this.patterns),c.addListener(a,"keydown",e.call(h,this)),c.addListener(a,"keypress",e.call(i,this)),c.addListener(a,"input",e.call(j,this)),""!=this._el.value&&j.call(this)},l.setting=m,l}),e(function(){return b("chuanr")})}();